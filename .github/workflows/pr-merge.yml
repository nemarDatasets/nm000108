name: PR Merge Handler

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_created: ${{ steps.create_release.outputs.created }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(jq -r '.Version // "1.0.0"' dataset_description.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag and release
        id: create_release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          VERSION="${{ steps.version.outputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          gh release create "v$VERSION" --title "v$VERSION" \
            --notes "Release v$VERSION from PR #${{ github.event.pull_request.number }}"
          echo "created=true" >> $GITHUB_OUTPUT

  publish-zenodo:
    name: Publish Zenodo DOI
    needs: create-release
    if: needs.create-release.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish version DOI
        env:
          NEMAR_WEBHOOK_TOKEN: ${{ secrets.NEMAR_WEBHOOK_TOKEN }}
        run: |
          # Extract dataset ID from repo name (e.g., nm000104)
          DATASET_ID="${{ github.event.repository.name }}"
          VERSION="${{ needs.create-release.outputs.version }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/v$VERSION"

          echo "Publishing DOI for $DATASET_ID version $VERSION"

          # Skip if webhook token not configured
          if [ -z "$NEMAR_WEBHOOK_TOKEN" ]; then
            echo "NEMAR_WEBHOOK_TOKEN not configured, skipping DOI publish"
            exit 0
          fi

          # Call NEMAR API to publish version DOI
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.osc.earth/nemar/webhooks/publish-version-doi" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Token: $NEMAR_WEBHOOK_TOKEN" \
            -d "{
              \"dataset_id\": \"$DATASET_ID\",
              \"version\": \"$VERSION\",
              \"release_url\": \"$RELEASE_URL\"
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            # Check if it was skipped (no concept DOI)
            if echo "$BODY" | jq -e '.skipped == true' > /dev/null 2>&1; then
              echo "Skipped: No concept DOI exists for this dataset"
              exit 0
            fi
            echo "::error::Failed to publish DOI (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Show DOI info
          DOI=$(echo "$BODY" | jq -r '.version_doi // empty')
          if [ -n "$DOI" ]; then
            echo "Version DOI published: $DOI"
          fi

  cleanup-staging:
    name: Cleanup Staging (runs on merge or close)
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Remove staging data for this PR/branch
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          DATASET_ID="${{ github.event.repository.name }}"
          BRANCH="${{ github.event.pull_request.head.ref }}"
          # Clean up branch-based staging
          aws s3 rm --recursive "s3://nemar/staging/${DATASET_ID}/${BRANCH}/" 2>/dev/null || true
          # Clean up legacy PR-number-based staging
          aws s3 rm --recursive "s3://nemar/staging/pr-${{ github.event.pull_request.number }}/" 2>/dev/null || true
